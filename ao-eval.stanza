defpackage ao-eval :
   import core
   import math
   import collections
   import reader
   import geom
   import eval
   import ao

public defn eval-ao (s:String) -> Tree :
  val forms = read-all(s)
  val es = unwrap-all(parse(forms))
  jit({ eval-begin(top-env, es) })

;;; TODO: TEMPORARY CHECKING UNTIL REPL MODE IMPLEMENTED IN COMPILER

val NodeT = Type(`Node, fn (x) : x is Node, fn (x): x as Node)
add-binding(top-env, `Node, NodeT)
val NodeThunkT = Type(`NodeThunk, fn (x) : x is (() -> Node), fn (x): x as (() -> Node))
add-binding(top-env, `NodeThunk, NodeThunkT)

defstruct TypeFailureException <: Exception : 
  arg:  ?
  idx:  Int
  type: Type

defmethod print (o:OutputStream, e:TypeFailureException) :
  print(o, "Expected Type %_ on %_th Arg %_" % [name(type(e)) idx(e) arg(e)])

defn check-type (arg, i:Int, type:Type) :
  if not isa?(type)(arg) :
    throw(TypeFailureException(arg, i, type))

defn checked-function (f, types:Tuple<Type>) -> ? :
  switch {length(types) == _} :
    0: fn () :
         f()
    1: fn (a0) :
         check-type(a0, 0, types[0])
         f(a0)
    2: fn (a0 a1) :
         check-type(a0, 0, types[0]) check-type(a1, 1, types[1])
         f(a0 a1)
    3: fn (a0 a1 a2) :
         check-type(a0, 3, types[0]) check-type(a1, 1, types[1]) check-type(a2, 2, types[2])
         f(a0 a1 a2)
    4: fn (a0 a1 a2 a3) :
         check-type(a0, 0, types[0]) check-type(a1, 1, types[1]) check-type(a2, 2, types[2])
         check-type(a3, 3, types[3])
         f(a0 a1 a2 a3)
    5: fn (a0 a1 a2 a3 a4) :
         check-type(a0, 0, types[0]) check-type(a1, 1, types[1]) check-type(a2, 2, types[2])
         check-type(a3, 3, types[3]) check-type(a4, 4, types[4])
         f(a0 a1 a2 a3 a4)
    6: fn (a0 a1 a2 a3 a4 a5) :
         check-type(a0, 0, types[0]) check-type(a1, 1, types[1]) check-type(a2, 2, types[2])
         check-type(a3, 3, types[3]) check-type(a4, 4, types[4]) check-type(a5, 5, types[5])
         f(a0 a1 a2 a3 a4 a5)

add-binding(top-env, `pi, pi)
add-binding(top-env, `hpi, 0.5 * pi)
add-binding(top-env, `pi2, 2.0 * pi)
add-binding(top-env, `lit, lit)
add-binding(top-env, `x, checked-function(fab-x, []))
add-binding(top-env, `y, checked-function(fab-y, []))
add-binding(top-env, `z, checked-function(fab-z, []))
add-binding(top-env, `diff, checked-function(difference, [NodeT, NodeT]))
add-binding(top-env, `bit-and, checked-function(bit-and, [NodeT, NodeT]))
add-binding(top-env, `bit-or, checked-function(bit-or, [NodeT, NodeT]))
add-binding(top-env, `plus, checked-function(plus, [NodeT, NodeT]))
add-binding(top-env, `minus, checked-function(minus, [NodeT, NodeT]))
add-binding(top-env, `times, checked-function(times, [NodeT, NodeT]))
add-binding(top-env, `divide, checked-function(divide, [NodeT, NodeT]))
add-binding(top-env, `negate, checked-function(negate, [NodeT]))
add-binding(top-env, `sin, checked-function(sin, [NodeT]))
add-binding(top-env, `cos, checked-function(cos, [NodeT]))
add-binding(top-env, `tan, checked-function(tan, [NodeT]))
add-binding(top-env, `asin, checked-function(asin, [NodeT]))
add-binding(top-env, `acos, checked-function(acos, [NodeT]))
add-binding(top-env, `atan, checked-function(atan, [NodeT]))
add-binding(top-env, `atan2, checked-function(atan2, [NodeT, NodeT]))
add-binding(top-env, `pow, checked-function(pow, [NodeT, NodeT]))
add-binding(top-env, `exp, checked-function(exp, [NodeT, NodeT]))
add-binding(top-env, `sqr, checked-function(sqr, [NodeT]))
add-binding(top-env, `edge, checked-function(edge, [NodeT, NodeT, NodeT, NodeT]))
add-binding(top-env, `tri, checked-function(triangle, [NodeT NodeT, NodeT, NodeT, NodeT, NodeT]))
add-binding(top-env, `rect, checked-function(rect, [NodeT, NodeT]))
add-binding(top-env, `square, checked-function(square, [NodeT]))
add-binding(top-env, `circle, checked-function(circle, [NodeT]))
add-binding(top-env, `convex, convex)
add-binding(top-env, `circle-n, checked-function(circle-n, [NodeT, IntT]))
add-binding(top-env, `cube, checked-function(cube, [NodeT]))
add-binding(top-env, `sphere, checked-function(sphere, [NodeT]))
add-binding(top-env, `mov, checked-function(move, [NodeT, NodeT, NodeT, NodeThunkT]))
add-binding(top-env, `mov-x, checked-function(move-x, [NodeT, NodeThunkT]))
add-binding(top-env, `mov-y, checked-function(move-y, [NodeT, NodeThunkT]))
add-binding(top-env, `mov-z, checked-function(move-x, [NodeT, NodeThunkT]))
add-binding(top-env, `mag, checked-function(scale, [NodeT, NodeT, NodeT, NodeThunkT]))
add-binding(top-env, `mag1, checked-function(scale1, [NodeT, NodeThunkT]))
add-binding(top-env, `mag-x, checked-function(scale-x, [NodeT, NodeThunkT]))
add-binding(top-env, `mag-y, checked-function(scale-y, [NodeT, NodeThunkT]))
add-binding(top-env, `mag-z, checked-function(scale-z, [NodeT, NodeThunkT]))
;; add-binding(top-env, `rot, checked-function(rotate, [NodeT, NodeT, NodeT, NodeT, NodeThunkT]))
add-binding(top-env, `rot-x, checked-function(rotate-x, [NodeT, NodeThunkT]))
add-binding(top-env, `rot-y, checked-function(rotate-y, [NodeT, NodeThunkT]))
add-binding(top-env, `rot-z, checked-function(rotate-z, [NodeT, NodeThunkT]))
add-binding(top-env, `rev, checked-function(revolve-y, [NodeThunkT]))
add-binding(top-env, `reflect-x, checked-function(reflect-x, [NodeThunkT]))
add-binding(top-env, `reflect-y, checked-function(reflect-y, [NodeThunkT]))
add-binding(top-env, `reflect-z, checked-function(reflect-z, [NodeThunkT]))
add-binding(top-env, `reflect-xy, checked-function(reflect-xy, [NodeThunkT]))
add-binding(top-env, `reflect-xz, checked-function(reflect-xz, [NodeThunkT]))
add-binding(top-env, `reflect-yz, checked-function(reflect-yz, [NodeThunkT]))
add-binding(top-env, `shear, checked-function(shear-x-y, [NodeT, NodeT, NodeT, NodeThunkT]))
add-binding(top-env, `taper, checked-function(taper-xy-z, [NodeT, NodeT, NodeT, NodeThunkT]))
add-binding(top-env, `offset, checked-function(offset, [NodeT, NodeT]))
add-binding(top-env, `clearance, checked-function(clearance, [NodeT, NodeT, NodeT]))
add-binding(top-env, `shell, checked-function(shell, [NodeT, NodeT]))
add-binding(top-env, `blend, checked-function(blend, [NodeT, NodeT, NodeT]))
add-binding(top-env, `morph, checked-function(morph, [NodeT, NodeT, NodeT]))
add-binding(top-env, `extrude, checked-function(extrude-z, [NodeT, NodeT]))
add-binding(top-env, `cyl, checked-function(cylinder-z, [NodeT, NodeT]))
add-binding(top-env, `capsule, checked-function(capsule-z, [NodeT, NodeT]))
add-binding(top-env, `cone, checked-function(cone-z, [NodeT, NodeT]))
add-binding(top-env, `pyr, checked-function(pyramid-z, [NodeT, NodeT]))
add-binding(top-env, `torus, checked-function(torus-z, [NodeT, NodeT]))
